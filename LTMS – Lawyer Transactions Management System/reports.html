<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>التقارير - نظام إدارة معاملات المحامين</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
                <span>LTMS</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <a href="index.html" class="nav-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="7" height="7"></rect>
                    <rect x="14" y="3" width="7" height="7"></rect>
                    <rect x="14" y="14" width="7" height="7"></rect>
                    <rect x="3" y="14" width="7" height="7"></rect>
                </svg>
                <span>لوحة التحكم</span>
            </a>
            <a href="lawyers.html" class="nav-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <span>المحامون</span>
            </a>
            <a href="transactions.html" class="nav-item">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="1" x2="12" y2="23"></line>
                    <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                </svg>
                <span>المعاملات</span>
            </a>
            <a href="reports.html" class="nav-item active">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <span>التقارير</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <button class="theme-toggle" id="themeToggle">
                <svg class="sun-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg class="moon-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="topbar no-print">
            <button class="menu-toggle" id="menuToggle">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <h1 class="page-title">التقارير</h1>
        </div>

        <div class="container">
            <!-- Report Generator -->
            <div class="card no-print">
                <div class="card-header">
                    <h2 class="card-title">إنشاء تقرير</h2>
                </div>
                <div class="card-body">
                    <form id="reportForm" onsubmit="generateReport(event)">
                        <div class="filters-grid">
                            <div class="form-group">
                                <label for="reportLawyer">المحامي</label>
                                <select id="reportLawyer" class="form-control" required>
                                    <option value="">اختر المحامي</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="reportDateFrom">من تاريخ</label>
                                <input type="date" id="reportDateFrom" class="form-control" required>
                            </div>

                            <div class="form-group">
                                <label for="reportDateTo">إلى تاريخ</label>
                                <input type="date" id="reportDateTo" class="form-control" required>
                            </div>

                            <div class="form-group" style="display: flex; align-items: flex-end; gap: 0.5rem;">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                    </svg>
                                    إنشاء التقرير
                                </button>
                                <button type="button" class="btn btn-success" onclick="settleDebts()" id="settleBtn" style="flex: 1;" disabled>
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    تسديد الديون
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Report Output -->
            <div id="reportOutput" style="display: none;">
                <div class="report-actions no-print">
                    <button class="btn btn-primary" onclick="window.print()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 6 2 18 2 18 9"></polyline>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                            <rect x="6" y="14" width="12" height="8"></rect>
                        </svg>
                        طباعة التقرير
                    </button>
                    <button class="btn btn-secondary" onclick="closeReport()">إغلاق</button>
                </div>

                <div class="print-container">
                    <div class="report-header">
                        <div class="report-logo">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="12" y1="18" x2="12" y2="12"></line>
                                <line x1="9" y1="15" x2="15" y2="15"></line>
                            </svg>
                        </div>
                        <h1 class="report-title">نظام إدارة معاملات المحامين</h1>
                        <p class="report-subtitle">تقرير معاملات المحامي</p>
                    </div>

                    <div class="report-info">
                        <div class="info-row">
                            <span class="info-label">اسم المحامي:</span>
                            <span class="info-value" id="reportLawyerName"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">رقم الهوية المهنية:</span>
                            <span class="info-value" id="reportProfessionalId"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">الفترة:</span>
                            <span class="info-value" id="reportPeriod"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">تاريخ التقرير:</span>
                            <span class="info-value" id="reportDate"></span>
                        </div>
                    </div>

                    <div class="report-summary">
                        <div class="summary-card">
                            <div class="summary-label">إجمالي المعاملات</div>
                            <div class="summary-value" id="summaryTotal">0</div>
                        </div>
                        <div class="summary-card summary-success">
                            <div class="summary-label">المبلغ المدفوع</div>
                            <div class="summary-value" id="summaryPaid">0 ريال</div>
                        </div>
                        <div class="summary-card summary-warning">
                            <div class="summary-label">المبلغ غير المدفوع</div>
                            <div class="summary-value" id="summaryUnpaid">0 ريال</div>
                        </div>
                        <div class="summary-card summary-primary">
                            <div class="summary-label">الإجمالي الكلي</div>
                            <div class="summary-value" id="summaryGrand">0 ريال</div>
                        </div>
                    </div>

                    <div class="report-table">
                        <h3 class="section-title">تفاصيل المعاملات</h3>
                        <table class="print-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>التاريخ</th>
                                    <th>عدد المستندات</th>
                                    <th>المبلغ</th>
                                    <th>الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody">
                            </tbody>
                        </table>
                    </div>

                    <div class="report-footer">
                        <p>تم إنشاء هذا التقرير بواسطة نظام إدارة معاملات المحامين (LTMS)</p>
                        <p>التوقيع: _________________</p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/storage.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/app.js"></script>
    <script>
        let currentReportLawyerId = null;
        let currentReportData = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadLawyersDropdown();
            setDefaultDates();
        });

        function loadLawyersDropdown() {
            const lawyers = storage.getLawyers();
            const select = document.getElementById('reportLawyer');
            
            select.innerHTML = '<option value="">اختر المحامي</option>' + 
                lawyers.map(l => `<option value="${l.id}">${l.name}</option>`).join('');
        }

        function setDefaultDates() {
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            
            document.getElementById('reportDateTo').value = today.toISOString().split('T')[0];
            document.getElementById('reportDateFrom').value = firstDay.toISOString().split('T')[0];
        }

        function generateReport(event) {
            event.preventDefault();
            
            const lawyerId = document.getElementById('reportLawyer').value;
            const dateFrom = document.getElementById('reportDateFrom').value;
            const dateTo = document.getElementById('reportDateTo').value;
            
            if (!lawyerId || !dateFrom || !dateTo) {
                showNotification('يرجى إكمال جميع الحقول', 'error');
                return;
            }
            
            const lawyer = storage.getLawyers().find(l => l.id === lawyerId);
            if (!lawyer) {
                showNotification('المحامي غير موجود', 'error');
                return;
            }
            
            const transactions = storage.getTransactions().filter(t => 
                t.lawyerId === lawyerId &&
                new Date(t.date) >= new Date(dateFrom) &&
                new Date(t.date) <= new Date(dateTo)
            );
            
            currentReportLawyerId = lawyerId;
            currentReportData = { transactions, dateFrom, dateTo };
            
            displayReport(lawyer, transactions, dateFrom, dateTo);
            
            // Enable settle button if there are unpaid transactions
            const hasUnpaid = transactions.some(t => !t.isPaid);
            document.getElementById('settleBtn').disabled = !hasUnpaid;
        }

        function displayReport(lawyer, transactions, dateFrom, dateTo) {
            // Calculate totals
            const totalCount = transactions.length;
            const totalPaid = transactions.filter(t => t.isPaid).reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const totalUnpaid = transactions.filter(t => !t.isPaid).reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const grandTotal = totalPaid + totalUnpaid;
            
            // Update report info
            document.getElementById('reportLawyerName').textContent = lawyer.name;
            document.getElementById('reportProfessionalId').textContent = lawyer.professionalId;
            document.getElementById('reportPeriod').textContent = `${formatDate(dateFrom)} - ${formatDate(dateTo)}`;
            document.getElementById('reportDate').textContent = formatDate(new Date().toISOString().split('T')[0]);
            
            // Update summary
            document.getElementById('summaryTotal').textContent = totalCount;
            document.getElementById('summaryPaid').textContent = formatCurrency(totalPaid);
            document.getElementById('summaryUnpaid').textContent = formatCurrency(totalUnpaid);
            document.getElementById('summaryGrand').textContent = formatCurrency(grandTotal);
            
            // Update table
            const tbody = document.getElementById('reportTableBody');
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">لا توجد معاملات في هذه الفترة</td></tr>';
            } else {
                tbody.innerHTML = transactions
                    .sort((a, b) => new Date(a.date) - new Date(b.date))
                    .map((t, idx) => `
                        <tr class="${!t.isPaid ? 'unpaid-row' : ''}">
                            <td>${idx + 1}</td>
                            <td>${formatDate(t.date)}</td>
                            <td>${t.documentCount}</td>
                            <td>${formatCurrency(t.amount)}</td>
                            <td><span class="print-badge ${t.isPaid ? 'badge-success' : 'badge-warning'}">${t.isPaid ? 'مدفوع' : 'غير مدفوع'}</span></td>
                        </tr>
                    `).join('');
            }
            
            // Show report
            document.getElementById('reportOutput').style.display = 'block';
            document.getElementById('reportOutput').scrollIntoView({ behavior: 'smooth' });
        }

        function closeReport() {
            document.getElementById('reportOutput').style.display = 'none';
            currentReportLawyerId = null;
            currentReportData = null;
            document.getElementById('settleBtn').disabled = true;
        }

        function settleDebts() {
            if (!currentReportLawyerId || !currentReportData) {
                showNotification('يرجى إنشاء تقرير أولاً', 'error');
                return;
            }
            
            if (!confirm('هل أنت متأكد من تسديد جميع الديون غير المدفوعة لهذا المحامي في هذه الفترة؟')) {
                return;
            }
            
            const { transactions } = currentReportData;
            let settledCount = 0;
            
            transactions.forEach(t => {
                if (!t.isPaid) {
                    t.isPaid = true;
                    storage.updateTransaction(t);
                    settledCount++;
                }
            });
            
            if (settledCount > 0) {
                showNotification(`تم تسديد ${settledCount} معاملة بنجاح`, 'success');
                
                // Regenerate report
                const lawyer = storage.getLawyers().find(l => l.id === currentReportLawyerId);
                const updatedTransactions = storage.getTransactions().filter(t => 
                    t.lawyerId === currentReportLawyerId &&
                    new Date(t.date) >= new Date(currentReportData.dateFrom) &&
                    new Date(t.date) <= new Date(currentReportData.dateTo)
                );
                
                displayReport(lawyer, updatedTransactions, currentReportData.dateFrom, currentReportData.dateTo);
                document.getElementById('settleBtn').disabled = true;
            } else {
                showNotification('لا توجد ديون لتسديدها', 'info');
            }
        }
    </script>
</body>
</html>